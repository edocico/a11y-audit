# a11y-audit Roadmap: v1.1 ‚Üí v2.0

## Objective

Transform a11y-audit from an experimental static contrast linter into a robust, enterprise-grade "Quality Gate" tool with IDE integration, brownfield adoption support, and intelligent fix suggestions.

## Phasing Strategy

**Approach: "Rust Early, Features On Top"** with compact thematic releases.

- Rust core engine ships first (Phase 1), establishing the performance foundation
- All subsequent features build on top of the native parser
- The existing TypeScript parser is frozen at v1.0 ("Legacy Fallback") ‚Äî no new features
- Quick wins US-07 (disabled states) and US-08 (currentColor) are bundled into the Rust parser from day one

| Phase | Theme | Items | Version |
|-------|-------|-------|---------|
| 1 | Rust Core Engine | PERF-01 + US-07 + US-08 | v1.1.0-native |
| 2 | Quality Gate | US-01 Baseline/Ratchet | v1.1.0 |
| 3 | Parser Precision | US-04 Portals + US-05 Opacity | v1.2.0 |
| 4 | Intelligence | US-03 Suggestions + US-06 CVA | v1.3.0 |
| 5 | Ecosystem | US-09 LSP + US-10 Color Blindness | v2.0.0 |

**Already completed:** US-02 (@a11y-context annotations) ‚Äî shipped in v1.0.

---

## Phase 1: Rust Core Engine (v1.1.0-native)

### Scope
PERF-01 (4 sub-tasks) + US-07 (disabled detection) + US-08 (currentColor resolution)

### 1a. NAPI-RS Infrastructure Setup
- Initialize Rust crate in `native/` directory
- Configure `napi-rs` with cross-platform build (Linux, macOS, Windows)
- Define shared types (`ClassRegion`, `ContrastResult`, `ColorPair`) as `#[napi]` structs ‚Äî auto-generates `.d.ts`
- CI: add native build step to existing workflow

### 1b. Math Engine
- Evaluate existing Rust crates (`palette`, `csscolorparser`) for color parsing (oklch, display-p3, hsl) before writing custom code. Manual implementation only if crates don't handle Tailwind's raw formats (unitless variables, shorthand).
- Port `compositeOver` (linear alpha blending) with separate channel handling (f32 precision)
- Port WCAG 2.1 ratio calculation (currently via `colord`)
- Port APCA Lc calculation (currently via `apca-w3`)
- **APCA constant verification:** cross-check coefficients (0.022 vs 0.027, exponents) against `apca-w3` JS. Write TS‚ÜîRust comparison tests as acceptance gate.
- **Color blindness matrices (for Phase 5):** Include Brettel/Machado 3x3 transformation matrices in the math engine from day one. Pure matrix multiplication on RGB vectors ‚Äî near-zero marginal cost with SIMD. Populate `deuteranopiaRatio` and `protanopiaRatio` fields in `ContrastResult` early, consume them in Phase 5.
- **Acceptance:** numerical results identical to existing TS suite (384 tests as oracle)

### 1c. Extensible Parser Core (Visitor Pattern)
- Tokenizer/Scanner: JSX ‚Üí event stream (not a full AST ‚Äî lossy lexer that distinguishes tags, attributes, comments, strings)
- Trait `JsxVisitor` with hooks: `on_tag_open`, `on_tag_close`, `on_comment`, `on_attribute`

**Visitors:**

| Visitor | Responsibility |
|---------|---------------|
| `ContextTracker` | LIFO container stack + `@a11y-context-block` push. Receives `ContainerConfig` from JS (already resolved). Exposes `get_current_bg()`. |
| `AnnotationParser` | Parses `@a11y-context`, `@a11y-ignore` from comments. Sets temporary flags for next line. |
| `ClassExtractor` | Extracts `className`/`class` values (strings, template literals, balanced parens for `cn(...)`). Queries ContextTracker for current bg, AnnotationParser for overrides. Produces `ClassRegion`. |
| `DisabledDetector` (US-07) | Detects `disabled` attribute, `aria-disabled="true"`, `disabled:` Tailwind variants. Flags element for skip. |
| `CurrentColorResolver` (US-08) | Tracks `contextColor` in the stack (lexical scope of single file only). Resolves `text-current`/`border-current`. If no ancestor defines color in current file ‚Üí emits `UnresolvedCurrentColor` ‚Üí counted as "Skipped" with reason `"currentColor unresolved (cross-file dependency)"`. |

**String handling (Rust):** Use `&str` and references inside the parser. Allocate `String` only for output objects (`ClassRegion`). Minimize copies when passing strings from JS via NAPI.

### 1d. Parallelization + Integration
- `rayon::par_iter` over files. Each file gets a fresh set of visitors (state isolation).
- API: `extract_and_scan(options: ExtractOptions) -> Vec<PreExtractedFile>`
- **Legacy Fallback (Frozen):** The TS parser (`parser.ts`, `categorizer.ts`, `region-resolver.ts`) is frozen at v1.0. No new features.
  - US-07 (disabled) and US-08 (currentColor) are **native-only**
  - If NAPI binding fails to load: warning `"‚ö† Running in legacy mode (native module unavailable). Disabled detection and currentColor resolution will be skipped."`
  - Audit proceeds with frozen TS path ‚Äî same results as v1.0
  - Exit code unchanged (degradation, not error)
- **Performance target:** >70% scan time reduction on 1000+ file codebase
- New entry point: `src/native/index.ts` ‚Äî `require()` NAPI binding with try/catch graceful fallback
- `pipeline.ts` selects path (native vs JS) based on availability

---

## Phase 2: Quality Gate ‚Äî US-01 Baseline/Ratchet

### Scope
Baseline system for brownfield adoption in CI.

### Hash Strategy: Content-Addressable Bag
- `hash = SHA-256(filePath + "::" + sortedBgClass + "::" + sortedFgClass + "::" + ruleId)`
- Classes sorted alphabetically ‚Üí `bg-red text-white` === `text-white bg-red`
- **No line number** in hash ‚Äî stable across refactoring
- Duplicates managed by count: 3 identical buttons with same error ‚Üí `count: 3`

### Reconciliation: Leaky Bucket
- Does not filter ‚Äî **annotates**: each violation gets `isBaseline: true/false`
- Per unique hash: `new = max(0, N_run - N_base)`
- Exit code based only on violations with `isBaseline: false`

### CLI Flags
- `--update-baseline` ‚Üí generate/update `.a11y-baseline.json`
- `--baseline-path <path>` ‚Üí override default path
- `--fail-on-improvement` ‚Üí CI fails if fewer violations than baseline (forces update, prevents stale baseline)

### JSON Structure (grouped by file, diff-friendly)
```json
{
  "version": "1.1.0",
  "generatedAt": "2026-02-13T14:00:00Z",
  "violations": {
    "src/components/Header.tsx": {
      "a1b2c3d4...": 2,
      "e5f6g7h8...": 1
    }
  }
}
```

### Modules
- `src/core/baseline.ts`: `generateViolationHash()`, `loadBaseline()`, `reconcileViolations()` ‚Üí `{ new[], known[], fixedCount }`
- `pipeline.ts`: `reconcileViolations` step before `generateReport`
- `schema.ts`: `baseline: { enabled: boolean, path: string, checkStale: boolean }`

### Report Integration
- Markdown: main section "New Violations (Must Fix)" + collapsible "Baseline Violations (Technical Debt)"
- Console: `"Found 15 violations. 12 known (baseline), 3 NEW ‚Üê Exit Code 1"`

### Accepted Risks
- Massive refactoring (component renames) ‚Üí manual `--update-baseline`
- File moves ‚Üí hash changes (path is identity) ‚Üí `--update-baseline`

---

## Phase 3: Parser Precision ‚Äî US-04 Portals + US-05 Opacity

### Scope
Reduce false positives/negatives by improving the Rust parser's context stack.

### US-04: React Portals (Context Reset)

**Problem:** A `<Dialog>` rendered via `createPortal` visually sits on a dark overlay, but in JSX it's nested under a white-background parent. Audit computes contrast against white ‚Üí false positive.

**Detection:**
- Pattern match on `createPortal(` ‚Äî first argument is content, context stack resets
- Configurable portal-like components via extended `ContainerConfig`

**Overlay vs Content distinction:**
Portal components map to a reset color:
```json
"portals": {
  "DialogOverlay": "bg-black/80",
  "DialogContent": "reset",
  "SheetContent": "reset",
  "PopoverContent": "bg-popover",
  "TooltipContent": "bg-primary-foreground"
}
```
- String value (e.g. `"bg-black/80"`) ‚Üí reset stack + use that color as base
- `"reset"` ‚Üí reset stack + use theme `pageBg`
- The `shadcn` preset includes default mappings. User can extend/override in config.

**StackEntry extension:**
```rust
struct StackEntry {
    tag_name: String,
    cumulative_bg: Color,
    cumulative_opacity: f32,
    is_portal_context: bool,  // ‚Üê US-04
}
```
When `is_portal_context = true`, `get_current_bg()` starts from that point ‚Äî everything below in the stack is ignored. Opacity also resets to `1.0` at the boundary.

### US-05: Opacity Stack

**Problem:** `<div className="opacity-50"><span className="text-white">` ‚Äî white text at 50% opacity on dark background has halved effective contrast, but audit ignores container opacity.

**Mechanics:**
- `ContextTracker` tracks `cumulative_opacity: f32` (default `1.0`)
- On `opacity-{N}` class ‚Üí multiply: `cumulative_opacity *= N / 100`
- On `tag_close` ‚Üí restore previous value (stack pop)
- `ClassExtractor` includes `effectiveOpacity: f32` in `ClassRegion`

**Visibility threshold:**
- `VISIBILITY_THRESHOLD = 0.1` (10%)
- If `cumulative_opacity < VISIBILITY_THRESHOLD` ‚Üí `ClassRegion` marked `ignored: true`, reason: `"Invisible (opacity < 10%)"`
- **Rust optimization:** if `stack.cumulative_opacity < 0.01`, skip class extraction for entire subtree. Continue structural parsing only for tag balancing.
- CSS opacity is multiplicative downward ‚Äî a child cannot be more opaque than its parent. Skip is safe.

**Compositing (v1.1 simplification):**
- Treat opacity as alpha reduction on foreground: `effectiveAlpha = color.alpha * effectiveOpacity`
- `compositeOver` already handles alpha compositing correctly with this input

**Supported classes:**
- `opacity-0` through `opacity-100` (Tailwind standard)
- `opacity-[<value>]` (arbitrary values, e.g. `opacity-[.33]`)
- **Not supported:** `style={{ opacity: 0.5 }}` inline ‚Äî requires future `StyleExtractor` visitor

---

## Phase 4: Intelligence ‚Äî US-03 Suggestions + US-06 CVA

### Scope
Transition from "tells you what's wrong" to "tells you how to fix it" and support advanced composition patterns.

### US-03: Suggestion Engine (Auto-fix Hints)

**Algorithm (luminosity-directed walk):**
1. Compute `L(bg)` (relative luminosity of the effective background)
2. If `L(bg) > 0.5` (light background) ‚Üí search for fg with lower L (darker)
3. If `L(bg) < 0.5` (dark background) ‚Üí search for fg with higher L (lighter)
4. For each candidate shade, **verify luminosity direction is correct** before computing ratio ‚Äî handles non-monotonic palette families (yellow, lime, amber)
5. Return the closest shade to the original (minimum shade distance) that meets the requirement (AA or AAA)

**Output:**
```
‚ùå text-gray-500 on bg-white ‚Üí 3.8:1 (required: 4.5:1 AA)
   üí° Suggestion: use text-gray-600 (5.1:1) or text-gray-700 (7.2:1)
```

**Edge cases:**
- No passing shade in family ‚Üí `"No suggestion available in the gray family. Consider changing the background."`
- Custom color (`text-[#7a7a7a]`) ‚Üí skip suggestion: `"Custom color ‚Äî no palette family to search"`
- Color with alpha (`text-gray-500/70`) ‚Üí suggest shade change and/or alpha change if either resolves

**Module:** `src/core/suggestions.ts` ‚Äî runs after contrast check, only on violations. Input: `FailedPair` + `ResolvedPalette`.

### US-06: CVA Support (Lightweight Heuristic ‚Äî Strada A)

**What is parsed:**
- Base classes (first string argument of `cva()`)
- `variants`: each key ‚Üí independent class set
- `defaultVariants`: merge with base to produce default combination

**What is explicitly ignored (documented):**
- `compoundVariants` ‚Üí skip with reason `"compoundVariants not supported in static analysis"`
- Variable keys (`[myKey]: "bg-red-500"`) ‚Üí skip
- Spread operators (`...sharedVariants`) ‚Üí skip
- `cva` definitions imported from other files ‚Üí `"Skipped (cross-file cva reference)"`

**Parsing constraints:**
- Definition must be a `const` in the same file
- Keys and values must be string literals
- `CvaExtractor` visitor uses textual pattern matching (not AST)

**Output:**
- For each `cva()` declaration: N virtual `ClassRegion`s
  - One for **default combination** (base + defaultVariants) ‚Üí always checked
  - One per **individual variant** ‚Üí checked only if `--check-all-variants` is active (opt-in)

**Synergy with US-03:** When a CVA variant fails contrast, the suggestion points to the **cva definition** (root cause), not the usage site.

**Config:**
```json
"cva": {
  "enabled": true,
  "checkAllVariants": false
}
```

**Estimated coverage:** ~90% of real-world usage (shadcn/ui standard uses simple variants with string literals, almost never compoundVariants for colors).

---

## Phase 5: Ecosystem ‚Äî US-09 LSP + US-10 Color Blindness (v2.0)

### US-09: Language Server Protocol Wrapper

**Architecture:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     LSP Protocol      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  VS Code / Neovim ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ stdio ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫    ‚îÇ  a11y-audit-lsp     ‚îÇ
‚îÇ  (any IDE)        ‚îÇ    (JSON-RPC)         ‚îÇ  (Node.js process)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                     ‚îÇ
                                            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                            ‚îÇ  Core Engine        ‚îÇ
                                            ‚îÇ  (Rust NAPI native) ‚îÇ
                                            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

- LSP server is a Node.js process using `vscode-languageserver`
- Reuses **entire** existing pipeline (config loading, Rust parser, contrast checker)
- Not a proprietary VS Code extension ‚Äî any LSP-capable editor works

**Analysis triggers:**
- `textDocument/didChange` with 300ms debounce (Rust speed makes real-time feasible, < 10ms per file)
- `textDocument/didOpen` ‚Üí initial file audit
- Results published as `Diagnostic` with configurable severity

**Diagnostics:**
```
src/Button.tsx:14:22 ‚ö† Contrast ratio 3.8:1 (required 4.5:1 AA)
  text-gray-500 on bg-white
  üí° Quick Fix: use text-gray-600 (5.1:1)
```
- Severity: `Warning` for AA fail, `Error` for AAA fail (configurable)
- Code Actions (Quick Fix): if suggestion engine has a suggestion ‚Üí propose as `CodeAction`
- Baseline-aware: baseline violations ‚Üí severity `Hint` (grey, not yellow)

**Long-running process concerns:**
- **Memory management:** NAPI binding must be careful about memory `drop`. If the Rust parser accumulates cache without releasing, the editor process bloats after hours of use. Implement explicit cache eviction on config reload.
- **Config hot-reload:** Watch `a11y-audit.config.*` for changes. On modification: invalidate cache, reload config, re-analyze open files. No VS Code restart required (critical DX requirement).
- **Debounce `didChange`:** 300ms debounce provides real-time feedback while preventing CPU thrashing on fast typing.

**Modules:**
- `packages/lsp/` (or `src/lsp/` if staying single-package)
- `src/lsp/server.ts` ‚Äî LSP setup, connection handler
- `src/lsp/analyzer.ts` ‚Äî bridge between LSP events and core pipeline

**Dependencies:** Requires Phase 1 (Rust, performance), Phase 2 (Baseline, noise control), benefits from Phase 4 (Suggestions, Quick Fix).

### US-10: Color Blindness Simulation

**Simulation types:**
- Protanopia (red-weak, ~1% males)
- Deuteranopia (green-weak, ~6% males ‚Äî most common)
- Tritanopia (blue-weak, rare)

**Implementation:**
- Brettel/Machado 3x3 transformation matrices live in the **Rust Math Engine** (Phase 1b)
- Pure matrix multiplication on RGB vectors ‚Äî near-zero cost with SIMD
- `ContrastResult` includes `deuteranopiaRatio` and `protanopiaRatio` fields populated during the standard contrast check pass
- Report generation (Phase 5) simply reads and formats these pre-computed values

**Report output:**

Markdown:
```
| Pair | Ratio | Deuteranopia | Protanopia |
|------|-------|-------------|------------|
| text-red-500 on bg-green-100 | 4.2:1 ‚ö† | 2.1:1 ‚ùå | 2.8:1 ‚ùå |
```

JSON: `colorBlindness: { deuteranopia: { ratio, passes }, protanopia: { ratio, passes } }`

**Scope for v2.0:**
- Numerical simulation only (ratios in report)
- No visual swatches (requires HTML/SVG output ‚Äî future US if needed)

---

## Dependency Graph

```
Phase 1 (Rust Core)
    ‚îú‚îÄ‚îÄ Phase 2 (Baseline) ‚îÄ‚îÄ‚îÄ depends on pipeline, not parser
    ‚îú‚îÄ‚îÄ Phase 3 (Portals + Opacity) ‚îÄ‚îÄ‚îÄ extends Rust parser visitors
    ‚îÇ       ‚îî‚îÄ‚îÄ Phase 4 (Suggestions + CVA) ‚îÄ‚îÄ‚îÄ needs palette + parser
    ‚îÇ               ‚îî‚îÄ‚îÄ Phase 5 (LSP + Color Blindness)
    ‚îÇ                       ‚îú‚îÄ‚îÄ LSP needs Phase 1+2+4
    ‚îÇ                       ‚îî‚îÄ‚îÄ Color Blindness needs Phase 1b (math engine)
```

## Versioning

| Version | Phases | Milestone |
|---------|--------|-----------|
| v1.1.0-native | Phase 1 | Rust core with feature parity + US-07/08 |
| v1.1.0 | Phase 2 | Baseline/Ratchet ‚Äî ready for brownfield CI adoption |
| v1.2.0 | Phase 3 | Portals + Opacity ‚Äî structural false positive reduction |
| v1.3.0 | Phase 4 | Suggestions + CVA ‚Äî intelligent fix guidance |
| v2.0.0 | Phase 5 | LSP + Color Blindness ‚Äî ecosystem integration |
